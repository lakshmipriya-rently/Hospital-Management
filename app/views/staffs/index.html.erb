<div class="container my-5">
  <h2 class="mb-4 text-primary fw-bold">Confirmed Appointments</h2>

  <% unassigned_appointments = @appointments.select do |appointment| 
    bill = Bill.find_by(appointment_id: appointment.id)
    bill.nil? || !bill.is_assigned end %>

  <% if unassigned_appointments.any? %>
    <div class="row">
      <% unassigned_appointments.each do |appointment| %>
        <% bill = Bill.find_by(appointment_id: appointment.id) %>
        <% patient = User.find_by(userable_id: appointment.patient.id, userable_type: "Patient") %>
      
        <% patient_user = User.find(patient.id) %>
        <% doctor = User.find_by(userable_id: appointment.doctor.id, userable_type: "Doctor") %>

        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card border-0 shadow rounded-4 h-100">
            <div class="card-body p-4">
              <h5 class="card-title text-primary fw-semibold mb-3">
                <i class="bi bi-person-fill"></i> <%= patient_user.name %>
              </h5>

              <ul class="list-unstyled mb-3">
                <li><strong><i class="bi bi-telephone-fill me-2"></i>Phone:</strong> <%= patient.phone_no %></li>
                <li><strong><i class="bi bi-activity me-2"></i>Disease:</strong> <%= appointment.disease %></li>
                <li><strong><i class="bi bi-calendar-event-fill me-2"></i>Date:</strong> <%= appointment.scheduled_at.strftime("%B %d, %Y") %></li>
                <li><strong><i class="bi bi-clock-fill me-2"></i>Time:</strong> <%= appointment.scheduled_at.strftime("%I:%M %p") %></li>
                <li><strong><i class="bi bi-person-badge-fill me-2"></i>Doctor:</strong> <%= doctor.name if doctor.userable_type %></li>
              </ul>

              <p class="mt-3">
                <strong>Status:</strong>
                <% badge_class = appointment.status == 'confirmed' ? 'bg-success' : 'bg-secondary' %>
                <span class="badge <%= badge_class %> text-uppercase px-3 py-2"><%= appointment.status %></span>
              </p>

              <%= link_to "Assign bill", new_bill_path(appointment_id: appointment.id), class: "btn btn-primary" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-info">No confirmed appointments without assigned bills.</div>
  <% end %>
</div>
