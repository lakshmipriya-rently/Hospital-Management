
<div class="d-flex justify-content-center align-items-center min-vh-100 bg-light">
  <div class="card shadow-lg p-4 rounded-4" style="max-width: 900px; width: 100%;">
    <h1 class="mb-4 text-center text-primary fw-bold">Create Account</h1>

    <%= form_for(resource, as: resource_name, url: registration_path(resource_name),  html: { data: { turbo: false } }) do |f| %>
      <% if resource.errors.any? %>
        <div class="alert alert-danger">
          <h5><%= pluralize(resource.errors.count, "error") %> prevented this form from saving:</h5>
          <ul>
            <% resource.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="mb-3">
        <%= f.label :name, class: "form-label fw-semibold" %>
        <%= f.text_field :name, class: "form-control" %>
      </div>

      <div class="mb-3">
        <%= f.label :phone_no, class: "form-label fw-semibold" %>
        <%= f.text_field :phone_no, class: "form-control" %>
      </div>

      <div class="mb-3">
        <%= f.label :dob, "Date of Birth", class: "form-label fw-semibold" %>
        <%= f.date_field :dob, class: "form-control" %>
      </div>

      <div class="mb-3">
        <%= f.label :gender, class: "form-label fw-semibold d-block" %>
        <div class="form-check form-check-inline">
          <%= f.radio_button :gender, "male", class: "form-check-input" %>
          <%= f.label :gender, "Male", value: "male", class: "form-check-label" %>
        </div>
        <div class="form-check form-check-inline">
          <%= f.radio_button :gender, "female", class: "form-check-input" %>
          <%= f.label :gender, "Female", value: "female", class: "form-check-label" %>
        </div>
        <div class="form-check form-check-inline">
          <%= f.radio_button :gender, "other", class: "form-check-input" %>
          <%= f.label :gender, "Other", value: "other", class: "form-check-label" %>
        </div>
      </div>

      <div class="mb-3">
        <%= f.label :email, class: "form-label fw-semibold" %>
        <%= f.email_field :email, autofocus: true, autocomplete: "email", class: "form-control" %>
      </div>

      <div class="mb-3">
        <%= f.label :password, class: "form-label fw-semibold" %>
        <%= f.password_field :password, autocomplete: "new-password", class: "form-control" %>
      </div>

      <div class="mb-3">
        <%= f.label :password_confirmation, class: "form-label fw-semibold" %>
        <%= f.password_field :password_confirmation, autocomplete: "new-password", class: "form-control" %>
      </div>

      <div class="mb-3 mt-4">
        <%= f.label :userable_type, "Role", class: "form-label fw-semibold" %>
        <%= f.select :userable_type, ['Doctor', 'Patient'], { prompt: 'Select your role' }, class: "form-select" %>
      </div>

    <%= f.fields_for :userable_attributes, @doctor do |u| %>
            <div id="doctor-fields" class="role-block" style="display:none;">
            <h4 class="mt-3 text-secondary fw-bold">Doctor Details</h4>

            <div class="mb-3">
              <%= u.label :license_id, "License ID", class: "form-label fw-semibold" %>
              <%= u.text_field :license_id, class: "form-control" %>
            </div>

            <div class="mb-3">
              <%= u.label :experience, class: "form-label fw-semibold" %>
              <%= u.number_field :experience, class: "form-control" %>
            </div>

            <div class="mb-3">
              <%= u.label :type_of_degree, "Degree Type", class: "form-label fw-semibold" %>
              <%= u.select :type_of_degree,
                          ['MBBS','MD','DO','BDS','MS','MCh','DM','DNB','PhD','FRCS'],
                          { prompt: 'Select a category' },
                          class: "form-select" %>
            </div>

            <div class="mb-3">
              <%= u.label :salary, class: "form-label fw-semibold" %>
              <%= u.number_field :salary, class: "form-control" %>
            </div>

            <div class="mb-3">
              <%= u.label :specialization_ids, "Specializations", class: "form-label fw-semibold" %>
              <%= u.collection_select :specialization_ids, Specialization.all, :id, :specialization,
                                      {}, { multiple: true, class: "form-select", size: 5 } %>
              <small class="form-text text-muted">Hold Ctrl/Command to select multiple.</small>
            </div>

            <h4 class="mt-4 text-secondary fw-bold">Doctor Availability</h4>
            <%= u.fields_for :available do |a| %>
              <div class="mb-3">
                <label class="form-label fw-semibold">Available Days</label>
                <div class="d-flex flex-wrap gap-3">
                  <% Date::DAYNAMES.each do |day| %>
                    <div class="form-check">
                      <%= check_box_tag "user[userable_attributes][available_attributes][available_days][]", day, @doctor&.available&.available_days&.include?(day), class: "form-check-input", id: "available_days_#{day}" %>
                      <%= label_tag "available_days_#{day}", day, class: "form-check-label" %>
                    </div>
                  <% end %>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= a.label :start_time, class: "form-label fw-semibold" %>
                  <%= a.time_select :start_time, {}, class: "form-select form-select-sm" %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= a.label :end_time, class: "form-label fw-semibold" %>
                  <%= a.time_select :end_time, {}, class: "form-select form-select-sm" %>
                </div>
              </div>
            <% end %>
          </div>
      <% end %>

      <%= f.fields_for :userable_attributes, @patient do |u| %>
            <div id="patient-fields" class="role-block" style="display:none;">
            <h4 class="mt-3 text-secondary fw-bold">Patient Details</h4>

            <div class="mb-3">
              <%= u.label :blood_group, "Blood Group", class: "form-label fw-semibold" %>
              <%= u.select :blood_group, ['A+','A-','B+','B-','AB+','AB-','O+','O-'],
                          { prompt: 'Select your blood group' },
                          { class: "form-select" } %>
            </div>

            <div class="mb-3">
              <%= u.label :organ_donor, "Do you want to donate organs?", class: "form-label fw-semibold d-block" %>
              <div class="form-check form-check-inline">
                <%= u.radio_button :organ_donor, true, id: "organ_donor_yes", class: "form-check-input" %>
                <%= u.label :organ_donor, "Yes", for: "organ_donor_yes", class: "form-check-label" %>
              </div>
              <div class="form-check form-check-inline">
                <%= u.radio_button :organ_donor, false, id: "organ_donor_no", class: "form-check-input" %>
                <%= u.label :organ_donor, "No", for: "organ_donor_no", class: "form-check-label" %>
              </div>
            </div>

            <div class="mb-3">
              <%= u.label :address, class: "form-label fw-semibold" %>
              <%= u.text_field :address, class: "form-control" %>
            </div>
          </div>
      <% end %>

      <div class="d-grid mt-3">
        <%= f.submit "Sign up", class: "btn btn-primary btn-lg fw-semibold" %>
      </div>
    <% end %>
  </div>
</div>
<style>
body {
  background-color: #f8f9fa;
}

.btn-primary {
  background-color: #3A9AD9;
  border-color: #3A9AD9;
  color: #fff;
}

.btn-primary:hover {
  background-color: #007BBA;
  border-color: #007BBA;
  color: #fff;
}

.btn-light {
  background-color: #fbfbfb;
  border: none;
  color: #007BBA;
}

.btn-light:hover {
  background-color: #14afe3;
  color: #fff;
}

.card.shadow-lg {
  border-radius: 1.25rem;
  box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
}

.card h1 {
  color: #3A9AD9;
}

.form-label.fw-semibold {
  font-weight: 600;
}

.role-block {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 1rem;
  border: 1px solid #e0e0e0;
  margin-top: 1rem;
}

.role-block h4 {
  font-size: 1.1rem;
  color: #6c757d;
  margin-bottom: 1rem;
}

.form-check-inline {
  margin-right: 1rem;
}

.form-check-input:disabled {
  background-color: #e9ecef;
  cursor: not-allowed;
}

.btn-primary.btn-lg {
  background-color: #3A9AD9;
  border-color: #3A9AD9;
  transition: background-color 0.3s ease;
}

.btn-primary.btn-lg:hover {
  background-color: #007BBA;
  border-color: #007BBA;
}

.form-select-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.form-text.text-muted {
  font-size: 0.8rem;
}

.d-flex.flex-wrap.gap-3 .form-check {
  margin-bottom: 0.25rem;
}

@media (max-width: 576px) {
  .card {
    padding: 1.5rem;
  }

  .role-block {
    padding: 1rem;
  }

  .form-check-inline {
    display: block;
    margin-bottom: 0.5rem;
  }
}
</style>

<script>
  document.addEventListener("DOMContentLoaded", setupRoleFields);
  document.addEventListener("turbo:load", setupRoleFields); // for Turbo/Hotwire

  function setupRoleFields() {
    const roleSelect = document.getElementById("user_userable_type");
    if (!roleSelect) return;

    const sections = {
      Doctor: document.getElementById("doctor-fields"),
      Patient: document.getElementById("patient-fields"),
      Staff: document.getElementById("staff-fields")
    };

    function toggleSection(section, show) {
      if (!section) return;
      section.style.display = show ? "block" : "none";

      const controls = section.querySelectorAll("input, select, textarea");
      controls.forEach(el => {
        // Prevent hidden fields from blocking form submit
        if (el.type !== "hidden") {
          el.disabled = !show;
        }
      });
    }

    function updateVisibility() {
      const selected = roleSelect.value;

      Object.keys(sections).forEach(role => {
        toggleSection(sections[role], role === selected);
      });
    }

    roleSelect.removeEventListener("change", updateVisibility);
    roleSelect.addEventListener("change", updateVisibility);

    updateVisibility(); // run once on load
  }
</script>
