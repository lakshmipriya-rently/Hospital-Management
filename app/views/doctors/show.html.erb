<%= stylesheet_link_tag "doctor", media: "all", "data-turbo-track": "reload" %>

<div class="container-fluid my-5">
  <div class="row min-vh-75"> 
    <!-- Sidebar / Doctor Profile -->
    <div class="col-lg-3 mb-4">
      <div class="card shadow-sm border-0 rounded-4 h-70">
        <div class="card-body text-center p-4 d-flex flex-column justify-content-between">
          <!-- Profile Image -->
          <div class="mb-3">
            <%= image_tag "doctor-profile.jpeg", class: "rounded-circle mb-3", style: "width:120px; height:120px; object-fit:cover;" %>
          </div>
          <% user = User.find_by(userable_id: @doctor.id, userable_type: "Doctor") %>
          <div>
            <h4 class="fw-bold mb-2"><%= user&.name || "N/A" %></h4>
            <p class="text-muted fs-6 mb-1"><%= user&.email || "N/A" %></p>
            <p class="text-muted fs-6"><%= user&.phone_no || "N/A" %></p>
          </div>
          <hr>
          <%= link_to edit_doctor_path(@doctor), class: "btn btn-warning w-100 mt-3" do %>
            <i class="bi bi-pencil-fill me-1"></i> Edit Profile
          <% end %>
        </div>
      </div>
    </div>

    <!-- Main Content / Appointments -->
    <div class="col-lg-9 d-flex flex-column">
      <h1 class="text-center mb-4 display-5 fw-bold text-primary border-bottom pb-3">
        Doctor's Appointments
      </h1>

      <!-- Toggle button to hide/show expired appointments -->
      <div class="text-end mb-3">
        <button type="button" id="toggle-expired-btn" class="btn btn-secondary">Hide expired</button>
      </div>

      <div class="row g-4 flex-grow-1 overflow-auto">
        <% @appointments.each do |appointment| %>
          <% patient = Patient.find(appointment.patient_id) %>
          <% user = User.find_by(userable_id: appointment.patient_id, userable_type: "Patient") %>
          <% expired = appointment.scheduled_at.present? && appointment.scheduled_at < Time.current %>

          <div class="col-md-6 col-lg-4" data-expired="<%= expired %>">
            <div class="card rounded-4 shadow-sm border-0 h-100">
              <!-- Card Header -->
              <div class="card-header text-white rounded-top-4 p-3" 
                   style="background: linear-gradient(135deg, #3A9AD9, #007BBA);">

                   
                   <h5 class="mb-0 fw-bold">üë§ <%= user&.name || "N/A" %></h5>
                   <% if user&.gender == "male" %>
                    <div class="ms-3">
                   <%= image_tag "man.avif", class: "rounded-circle", style: "width:100px; height:100px; object-fit:cover;" %>
                  </div>
                  <% else %>
                  <div class="ms-3">
                   <%= image_tag "women.avif", class: "rounded-circle", style: "width:100px; height:100px; object-fit:cover;" %>
                  </div>
                  <% end %>

                   </div>
                   
                   <!-- Card Body -->
                   <div class="card-body d-flex flex-column justify-content-between">
                   <div>
                   <p><strong>ü©∫ Disease:</strong> <%= appointment.disease || "N/A" %></p>
                   <p><strong>üìû Phone:</strong> <%= user&.phone_no || "N/A" %></p>
                   <p><strong>üìÖ Date:</strong> <%= appointment.scheduled_at ? appointment.scheduled_at.strftime("%B %d, %Y") : "N/A" %></p>
                   <p><strong>‚è∞ Time:</strong> <%= appointment.scheduled_at ? appointment.scheduled_at.strftime("%I:%M %p") : "N/A" %></p>
                   <p>
                   <strong>üìå Status:</strong> 
                   <span class="badge 
                   <%= case appointment.status
                   when "pending" then "bg-warning text-dark"
                   when "confirmed" then "bg-success"
                   when "cancelled" then "bg-danger"
                   else "bg-info text-dark"
                   end %>">
                   <%= appointment.status.capitalize %>
                   </span>
                   </p>
                   <p>
                   <strong> Fee:</strong> 
                   <span class="badge bg-primary">
                   <%= number_to_currency(appointment.bill&.tot_amount || 0) %>
                   </span>
                   </p>
                   </div>
                   
                <!-- Status Update Form -->
                <% if appointment.scheduled_at >= Date.today && appointment.scheduled_at >= Time.current %>
                <%= form_with model: appointment, method: :patch, local: true do |f| %>
              <div class="input-group mb-3">
                <%= f.select :status, Appointment.statuses.keys.map { |s| [s.capitalize, s] }, {}, class: "form-select" %>
                <button class="btn btn-outline-primary" type="submit">Update</button>
              </div>
            <% end %>   
            <% if appointment.bill.present? %>
             <%= form_with model: appointment.bill, method: :patch, local: true do |f| %>
             <div class="input-group mb-3">
             <%= f.number_field :tot_amount, step: 0.01, class: "form-control", value: appointment.bill.tot_amount %>
      <button class="btn btn-outline-primary" type="submit">Update</button>
    </div>
  <% end %>
  <% end %>

<% else %>
            <h6 class="badge bg-danger"> appointment expired </h6>
      <% end %>

              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

  </div>
</div>

<!-- Inline JS to toggle expired appointment cards -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("toggle-expired-btn");
    if (!btn) return;
    let hidden = false;

    function setButtonState() {
      btn.textContent = hidden ? "Show expired" : "Hide expired";
      btn.classList.toggle("btn-secondary", !hidden);
      btn.classList.toggle("btn-outline-secondary", hidden);
    }

    function updateExpiredVisibility() {
      document.querySelectorAll('[data-expired="true"]').forEach(el => {
        if (hidden) el.classList.add("d-none"); else el.classList.remove("d-none");
      });
    }

    btn.addEventListener("click", function() {
      hidden = !hidden;
      updateExpiredVisibility();
      setButtonState();
    });

    // Optionally hide expired on initial load (keep false to show by default)
    // hidden = true; updateExpiredVisibility(); setButtonState();
  });
</script>
